#!/usr/bin/env bash
# shellcheck shell=bash
# fgithub - Install tools from GitHub releases

set -Eeuo pipefail

mydir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${mydir}/../../helper/set_variable.sh"
source "${mydir}/../../helper/colors.sh"
source "${mydir}/../../helper/logger.sh"
source "${mydir}/../../helper/prompts.sh"
source "${mydir}/../../helper/utils.sh"
trap on_error ERR

function usage() { echo "Usage: fgithub [-h] - Install GitHub release tools"; }

function main() {
    [[ "${1:-}" =~ ^(-h|--help)$ ]] && usage && exit 0
    [ "${INSTALL_EXTRAS:-0}" -ne 1 ] && return 0
    
    clear 2>/dev/null || true
    logo "Instalando herramientas desde GitHub"
    sleep 2
    
    preflight_utils
    
    local AUTH_HEADER=()
    [ -n "${GITHUB_TOKEN:-}" ] && AUTH_HEADER=(-H "Authorization: token $GITHUB_TOKEN")
    
    # NVM
    local NVM_DIR
    NVM_DIR="$(get_nvm_dir)"
    [ ! -d "$NVM_DIR" ] && {
        print_info "Instalando NVM..."
        mkdir -p "$(dirname "$NVM_DIR")"
        curl -sS https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash
        # shellcheck disable=SC1090,SC1091
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        printf "%b\n" "  ${BLD}${CGR}NVM instalado${CNC}"
    } || printf "%b\n" "${BLD}${CGR}NVM instalado${CNC}"
    
    # Lua Language Server
    command -v lua-language-server >/dev/null 2>&1 || {
        print_info "Instalando Lua-LS..."
        local arch=$(uname -m)
        [[ $arch == "aarch64" ]] && arch="arm64"
        [[ $arch == "x86_64" ]] && arch="x64"
        
        # shellcheck disable=SC2086
        local url=$(curl -s ${AUTH_HEADER[@]} https://api.github.com/repos/LuaLS/lua-language-server/releases/latest \
            | jq -r ".assets[] | select(.name | contains(\"linux-$arch\")) | .browser_download_url")
        
        [ -n "$url" ] && {
            wget -q "$url" -O /tmp/lua-ls.tar.gz
            mkdir -p "$HOME/.local/share/lua-language-server"
            tar -xzf /tmp/lua-ls.tar.gz -C "$HOME/.local/share/lua-language-server"
            cat > "$HOME/.local/bin/lua-language-server" << 'EOF'
#!/usr/bin/env bash
exec "$HOME/.local/share/lua-language-server/bin/lua-language-server" "$@"
EOF
            chmod +x "$HOME/.local/bin/lua-language-server"
            rm /tmp/lua-ls.tar.gz
            printf "%b\n" "  ${BLD}${CGR}Lua-LS instalado${CNC}"
        }
    } || printf "%b\n" "${BLD}${CGR}lua-language-server instalado${CNC}"
    
    # lazygit
    command -v lazygit >/dev/null 2>&1 || {
        print_info "Instalando lazygit..."
        local arch=$(uname -m)
        # shellcheck disable=SC2086
        local url=$(curl -s ${AUTH_HEADER[@]} https://api.github.com/repos/jesseduffield/lazygit/releases/latest \
            | jq -r ".assets[] | select(.name | contains(\"Linux_$arch\")) | .browser_download_url")
        
        [ -n "$url" ] && {
            wget -q "$url" -O /tmp/lazygit.tar.gz
            tar -xzf /tmp/lazygit.tar.gz -C /tmp
            mv /tmp/lazygit "$HOME/.local/bin/"
            chmod +x "$HOME/.local/bin/lazygit"
            rm /tmp/lazygit.tar.gz
            printf "%b\n" "  ${BLD}${CGR}lazygit instalado${CNC}"
        }
    } || printf "%b\n" "${BLD}${CGR}lazygit instalado${CNC}"
    
    # gh (GitHub CLI)
    command -v gh >/dev/null 2>&1 || {
        print_info "Instalando GitHub CLI..."
        local arch=$(uname -m)
        [[ $arch == "aarch64" ]] && arch="arm64"
        [[ $arch == "x86_64" ]] && arch="amd64"
        
        # shellcheck disable=SC2086
        local url=$(curl -s ${AUTH_HEADER[@]} https://api.github.com/repos/cli/cli/releases/latest \
            | jq -r ".assets[] | select(.name | contains(\"linux_$arch.tar.gz\")) | .browser_download_url")
        
        [ -n "$url" ] && {
            wget -q "$url" -O /tmp/gh.tar.gz
            tar -xzf /tmp/gh.tar.gz -C /tmp
            cp /tmp/gh_*/bin/gh "$HOME/.local/bin/"
            chmod +x "$HOME/.local/bin/gh"
            rm -rf /tmp/gh.tar.gz /tmp/gh_*
            printf "%b\n" "  ${BLD}${CGR}gh instalado${CNC}"
        }
    } || printf "%b\n" "${BLD}${CGR}gh instalado${CNC}"
    
    # zoxide
    command -v zoxide >/dev/null 2>&1 || {
        print_info "Instalando zoxide..."
        curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
        printf "%b\n" "  ${BLD}${CGR}zoxide instalado${CNC}"
    } || printf "%b\n" "${BLD}${CGR}zoxide instalado${CNC}"
    
    # tldr (tealdeer)
    command -v tldr >/dev/null 2>&1 || {
        print_info "Instalando tldr..."
        local arch=$(uname -m)
        [[ $arch == "aarch64" ]] && arch="arm-musleabi"
        [[ $arch == "x86_64" ]] && arch="x86_64-musl"
        
        # shellcheck disable=SC2086
        local url=$(curl -s ${AUTH_HEADER[@]} https://api.github.com/repos/dbrgn/tealdeer/releases/latest \
            | jq -r ".assets[] | select(.name | contains(\"linux-$arch\")) | .browser_download_url")
        
        [ -n "$url" ] && {
            wget -q "$url" -O "$HOME/.local/bin/tldr"
            chmod +x "$HOME/.local/bin/tldr"
            "$HOME/.local/bin/tldr" --update >/dev/null 2>&1 || true
            printf "%b\n" "  ${BLD}${CGR}tldr instalado${CNC}"
        }
    } || printf "%b\n" "${BLD}${CGR}tldr instalado${CNC}"
    
    # Deno
    command -v deno >/dev/null 2>&1 || {
        print_info "Instalando Deno..."
        curl -fsSL https://deno.land/x/install/install.sh | DENO_INSTALL="$HOME/.local" sh
        printf "%b\n" "  ${BLD}${CGR}Deno instalado${CNC}"
    } || printf "%b\n" "${BLD}${CGR}deno instalado${CNC}"
    
    printf "\n%b\n" "${BLD}${CGR}Herramientas GitHub instaladas!${CNC}"
    sleep 3
}

[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"

