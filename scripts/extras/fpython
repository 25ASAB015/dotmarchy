#!/usr/bin/env bash
# shellcheck shell=bash
# fpython - Install Python packages (pip/pipx)

set -Eeuo pipefail

mydir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${mydir}/../../helper/set_variable.sh"
source "${mydir}/../../helper/colors.sh"
source "${mydir}/../../helper/logger.sh"
source "${mydir}/../../helper/prompts.sh"
trap on_error ERR

function usage() { echo "Usage: fpython [-h] - Install Python packages (pip/pipx)"; }

function main() {
    [[ "${1:-}" =~ ^(-h|--help)$ ]] && usage && exit 0
    [ "${INSTALL_EXTRAS:-0}" -ne 1 ] && return 0
    
    clear 2>/dev/null || true
    logo "Instalando Paquetes de Python (pip/pipx)"
    sleep 2
    
    command -v python3 >/dev/null 2>&1 || { log_error "python3 no instalado"; return 1; }
    
    # Detect Arch Linux (PEP 668)
    local use_pipx_only=0
    [ -f /etc/os-release ] && {
        # shellcheck source=/dev/null
        . /etc/os-release
        [[ "${ID:-}" = "arch" ]] || [[ ${ID_LIKE:-} == *"arch"* ]] && {
            print_info "Arch Linux detectado - usando solo pipx (PEP 668)"
            use_pipx_only=1
        }
    }
    
    # Ensure pipx
    print_info "Verificando pipx..."
    command -v pipx >/dev/null 2>&1 || {
        [ $use_pipx_only -eq 1 ] && {
            log_error "pipx no instalado. Instala python-pipx con pacman"
            return 1
        } || python3 -m pip install --user pipx 2>&1 | grep -v "already satisfied" || true
    }
    
    pipx ensurepath --force 2>&1 | grep -v "already in PATH" || true
    export PATH="$HOME/.local/bin:$PATH"
    
    # pip packages (only if not Arch)
    [ $use_pipx_only -eq 0 ] && {
        local pip_pkgs="pynvim jedi pygments"
        [ -f "$SETUP_CONFIG" ] && {
            # shellcheck source=/dev/null
            source "$SETUP_CONFIG"
            pip_pkgs="${PIP_PACKAGES[*]:-$pip_pkgs}"
        }
        
        print_info "Instalando bibliotecas pip..."
        for pkg in $pip_pkgs; do
            python3 -m pip install --user "$pkg" 2>&1 | grep -v "already satisfied" || true
        done
    }
    
    # pipx packages
    local pipx_pkgs="doq beautysh black ruff neovim-remote flake8 python-lsp-server pyright rich-cli trash-cli codespell"
    [ -f "$SETUP_CONFIG" ] && {
        # shellcheck source=/dev/null
        source "$SETUP_CONFIG"
        pipx_pkgs="${PIPX_PACKAGES[*]:-$pipx_pkgs}"
    }
    
    print_info "Instalando aplicaciones pipx..."
    for pkg in $pipx_pkgs; do
        pipx list 2>/dev/null | grep -q "package $pkg" && \
            printf "%b\n" "${BLD}${CGR}$pkg instalado${CNC}" || {
            printf "%b\n" "${BLD}${CBL}Instalando: $pkg${CNC}"
            pipx install "$pkg" >>"$ERROR_LOG" 2>&1 || log_error "Error: $pkg"
        }
    done
    
    printf "\n%b\n" "${BLD}${CGR}Paquetes Python instalados!${CNC}"
    sleep 3
}

[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"

