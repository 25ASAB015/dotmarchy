#!/usr/bin/env bash
# shellcheck shell=bash
# shfmt: -ln=bash
#
# faur - Install dependencies from AUR (Arch User Repository)
#
# Installs packages from AUR using paru. Always installs dotbare.
# If --extras flag is set, also installs additional AUR packages from config or defaults.
#
# @params
# Globals:
#   ${INSTALL_EXTRAS}: Flag for extra packages
#   ${SETUP_CONFIG}: Path to setup configuration
#   ${DEFAULT_EXTRA_AUR_APPS}: Default extra AUR packages
#   ${ERROR_LOG}: Path to error log file
# Arguments:
#   -h|--help: Show help message and exit
# Returns:
#   0 on success
#   1 on failure

set -Eeuo pipefail

# Determine script directory
mydir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source required helpers
source "${mydir}/../../helper/set_variable.sh"
source "${mydir}/../../helper/colors.sh"
source "${mydir}/../../helper/logger.sh"
source "${mydir}/../../helper/prompts.sh"
source "${mydir}/../../helper/checks.sh"

# Setup error trap
trap on_error ERR

#######################################
# Display usage information
#######################################
function usage() {
  echo -e "Usage: faur [-h]

Install packages from AUR (Arch User Repository) using paru.
Always installs dotbare. With --extras flag, installs additional AUR packages.

Default packages:
  dotbare (dotfiles manager)

Optional arguments:
  -h, --help\t\tshow this help message and exit."
}

#######################################
# Main function - install AUR dependencies
#######################################
function main() {
    if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        usage
        exit 0
    fi
    
    clear 2>/dev/null || true
    logo "Instalando las dependencias necesarias desde AUR..."
    sleep 2
    
    # Build AUR package list
    local aur_apps="dotbare"
    
    # Add extra AUR packages if --extras flag is set
    if [ "${INSTALL_EXTRAS:-0}" -eq 1 ]; then
        local extra_aur=""
        if [ -f "$SETUP_CONFIG" ]; then
            # shellcheck source=/dev/null
            source "$SETUP_CONFIG"
            extra_aur="${EXTRA_AUR_APPS[*]:-$DEFAULT_EXTRA_AUR_APPS}"
        else
            extra_aur="$DEFAULT_EXTRA_AUR_APPS"
        fi
        
        aur_apps="$aur_apps $extra_aur"
        printf "\n%b\n" "${BLD}${CYE}[--extras] Incluyendo paquetes adicionales opcionales desde AUR${CNC}"
    fi
    
    printf "%b\n\n" "${BLD}${CBL}Verificando las dependencias necesarias...${CNC}"
    sleep 2
    
    # Detect missing AUR packages
    local missing_aur=""
    for pkg in $aur_apps; do
        if ! is_installed "$pkg"; then
            missing_aur="$missing_aur $pkg"
            printf "%b\n" " ${BLD}${CYE}$pkg ${CRE}no instalado${CNC}"
        else
            printf "%b\n" "${BLD}${CGR}$pkg ${CBL}ya está instalado${CNC}"
        fi
    done
    
    # Install missing AUR packages (one by one for better error handling)
    if [ -n "$(printf "%s" "$missing_aur" | tr -s ' ')" ]; then
        local count
        count=$(printf "%s" "$missing_aur" | wc -w)
        printf "\n%b\n\n" "${BLD}${CYE}Instalando $count paquetes AUR, por favor espera...${CNC}"
        
        local aur_failed=""
        for pkg in $missing_aur; do
            printf "%b\n" "${BLD}${CBL}Processing: ${pkg}${CNC}"
            
            if paru -S --skipreview --noconfirm "$pkg" >>"$ERROR_LOG" 2>&1; then
                printf "%b\n" "  ${BLD}${CGR}Se ha instalado correctamente!${CNC}"
            else
                log_error "Error al instalar el paquete AUR: $pkg"
                aur_failed="$aur_failed $pkg"
                printf "%b\n" "  ${BLD}${CRE}Error al instalar${CNC}"
            fi
            sleep 0.5
        done
        
        # Show final results
        if [ -n "$(printf "%s" "$aur_failed" | tr -s ' ')" ]; then
            local fail_count
            fail_count=$(printf "%s" "$aur_failed" | wc -w)
            printf "%b\n" "\n${BLD}${CRE}Error al instalar $fail_count/$count paquetes AUR:${CNC}"
            printf "%b\n\n" "${BLD}${CYE}$(printf "%s" "$aur_failed")${CNC}"
        else
            printf "\n%b\n\n" "${BLD}${CGR}Todos los paquetes AUR se han instalado correctamente!${CNC}"
        fi
    else
        printf "\n%b\n\n" "${BLD}${CGR}Todas las dependencias AUR ya están instaladas!${CNC}"
    fi
    
    sleep 3
}

# Execute only if invoked directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi

