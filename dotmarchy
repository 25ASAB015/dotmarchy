#!/usr/bin/env bash
# shellcheck shell=bash
# shfmt: -ln=bash
#
# dotmarchy - Main entry point and router script
#
# Modular dotfiles installation and system setup tool for Arch Linux.
# Routes commands to appropriate scripts following the dotbare architecture pattern.
#
# @usage
#   dotmarchy [--extras] [--setup-env] [--verify] [--repo URL] [REPO_URL]
#
# @architecture
#   Main router → helper/ (shared libraries) → scripts/ (operations)

set -Eeuo pipefail

# Determine script directory
mydir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source all helpers in correct order
source "${mydir}/helper/set_variable.sh"  # Variables first
source "${mydir}/helper/colors.sh"        # Colors
source "${mydir}/helper/logger.sh"        # Logging
source "${mydir}/helper/utils.sh"         # Utilities
source "${mydir}/helper/checks.sh"        # System checks
source "${mydir}/helper/prompts.sh"       # User interaction

# Setup error trap
trap on_error ERR

#######################################
# Main execution flow
# Orchestrates all installation steps in correct order
#######################################
main() {
    # Parse CLI arguments and flags
    parse_args "$@"
    
    # Perform initial system checks
    initial_checks
    
    # If verify mode is active, run verification and exit
    if [ "${VERIFY_MODE:-0}" -eq 1 ]; then
        exec "${mydir}/scripts/fverify"
    fi
    
    # Display welcome screen and get user confirmation
    welcome
    
    # ===== DOTBARE CONFIGURATION (executed first to make setup.conf available) =====
    # Configure dotbare and clone dotfiles repository BEFORE other installations
    # This ensures setup.conf from the dotfiles repo is available for setup scripts
    info "Configurando dotbare (clonando dotfiles)..."
    "${mydir}/scripts/core/fdotbare"
    
    # ===== CORE OPERATIONS (always executed) =====
    info "Iniciando operaciones core..."
    
    # System update
    "${mydir}/scripts/core/fupdate"
    
    # Configure Chaotic-AUR repository
    "${mydir}/scripts/core/fchaotic"
    
    # Install dependencies from official repos
    "${mydir}/scripts/core/fdeps"
    
    # Install dependencies from Chaotic-AUR
    "${mydir}/scripts/core/fchaotic-deps"
    
    # Install AUR packages (includes dotbare from AUR, but dotbare is already available)
    "${mydir}/scripts/core/faur"
    
    # ===== EXTRAS OPERATIONS (only if --extras) =====
    if [ "${INSTALL_EXTRAS:-0}" -eq 1 ]; then
        info "Iniciando instalación de extras..."
        
        "${mydir}/scripts/extras/fnpm"      # npm packages
        "${mydir}/scripts/extras/fcargo"    # Rust/Cargo packages
        "${mydir}/scripts/extras/fpython"   # Python packages (pip/pipx)
        "${mydir}/scripts/extras/fruby"     # Ruby gems
        "${mydir}/scripts/extras/fgithub"   # GitHub releases
        "${mydir}/scripts/extras/fpath"     # Configure PATH
    else
        debug "Saltando extras (--extras no activado)"
    fi
    
    # ===== SETUP OPERATIONS (only if --setup-env) =====
    if [ "${SETUP_ENVIRONMENT:-0}" -eq 1 ]; then
        info "Iniciando configuración de entorno..."
        
        # Use unified setup script for better UX (all in one screen, like monolithic)
        "${mydir}/scripts/setup/fenv-setup"
    else
        debug "Saltando setup (--setup-env no activado)"
    fi
    
    # ===== COMPLETION =====
    farewell
}

# Execute main function with all arguments
main "$@"

